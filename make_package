#!/bin/bash

if [ "Linux" != "$(uname -s)" ]; then
    echo "You can only build this on a Linux host."
    exit 2
fi

if [ -n "$(git status --porcelain)" ]; then
    echo "There are uncommitted modifications - not making a package!"
    exit 1
fi

DESCRIBE=$(git describe)
INSTALL_PATH='.stack-work/install/x86_64-*/lts-2.*/7.*/bin'

stack clean
stack build

mkdir -p target
tar czf target/aemo-archiver-${DESCRIBE}.tar.gz \
  createdb \
  registrations \
  power_station_metadata \
  -C ${INSTALL_PATH} \
    aemo-archiver \
    initDB
