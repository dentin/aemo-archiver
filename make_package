#!/bin/bash

git diff-index --quiet HEAD
CLEAN=$?
if [[ ! ${CLEAN} == 0 ]]; then
    echo "There are uncommitted modifications - not making a package!"
    exit 1
fi

DESCRIBE=$(git describe)
BRANCH=$(git rev-parse --abbrev-ref HEAD)

cabal sandbox init
cabal clean
cabal install -j --only-dependencies
cabal build

mkdir -p target
tar czf target/aemo-archiver-${BRANCH}-${DESCRIBE}.tar.gz \
  dist/build/AEMO-archiver/AEMO-archiver \
  dist/build/initDB/initDB \
  createdb \
  registrations \
  power_station_metadata
